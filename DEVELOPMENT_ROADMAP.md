# CHTL 编译器 - 完整开发路线图

**创建日期**: 2025-10-15  
**当前版本**: v0.5.0-script-support  
**目标版本**: v1.0.0-full-featured  
**预计完成时间**: 分多个里程碑逐步实现

---

## 📊 项目当前状态

### 已完成功能（v0.5.0）

| 功能模块 | 规范位置 | 状态 | 测试覆盖 |
|---------|---------|------|---------|
| 词法分析器 | - | ✅ | 11 用例/121 断言 |
| 语法分析器 | - | ✅ | 6 用例/60 断言 |
| 代码生成器 | - | ✅ | 8 用例/40 断言 |
| 注释系统 | 4-15行 | ✅ | 已覆盖 |
| 文本节点 | 17-35行 | ✅ | 已覆盖 |
| 字面量 | 37-51行 | ✅ | 已覆盖 |
| CE对等式 | 53-56行 | ✅ | 已覆盖 |
| 元素节点 | 58-85行 | ✅ | 已覆盖 |
| 属性 | 87-101行 | ✅ | 已覆盖 |
| 内联样式 | 109-125行 | ✅ | 6 用例/40 断言 |
| 属性运算 | 175-202行 | ✅ | 12 用例/46 断言 |
| 脚本块 | - | ✅ | 5 用例/31 断言 |
| 生产环境加固 | - | ✅ | 8 用例/42 断言 |

**统计**:
- 代码规模: ~6,500 行
- 测试用例: 56 个
- 断言数量: 380 个
- 通过率: 100%
- 规范符合度: ~60% (核心功能 100%)

---

## 🎯 完整开发路线

### 🚀 第一阶段：样式系统增强（v0.6.0）

**优先级**: ⭐⭐⭐⭐⭐ 高  
**预计工作量**: 2-3 周  
**目标**: 完善样式系统，支持类/id自动化和全局样式

#### Step 7.1: 自动化类名/id（CHTL.md 127-143行）

**目标**: 在 style 块中使用 `.box` 自动为元素添加类名

**功能描述**:
```chtl
div {
    style {
        .box {           // 自动添加 class="box"
            width: 300px;
        }
    }
}
```

**生成结果**:
```html
<div class="box" />
<style>
.box {
    width: 300px;
}
</style>
```

**技术实现**:
1. 在 Lexer 中添加 `.` 和 `#` 选择器识别
2. 在 Parser 中解析类选择器/id选择器
3. 自动为元素添加 `class` 或 `id` 属性
4. 提取样式规则到全局样式块
5. 在 Generator 中生成独立的 `<style>` 标签

**新增组件**:
- `GlobalStyleCollector`: 收集全局样式
- `SelectorParser`: 解析 CSS 选择器
- `ClassIdManager`: 管理自动生成的类名/id

**测试用例**: 6-8 个
**预计代码量**: ~300 行

---

#### Step 7.2: 上下文推导&（CHTL.md 145-173行）

**目标**: 使用 `&` 引用当前元素的类名/id

**功能描述**:
```chtl
div {
    style {
        .box {
            width: 300px;
        }
        
        &:hover {        // & 会被解析为 .box
            width: 350px;
        }
        
        &::before {      // 伪元素
            content: ">";
        }
    }
}
```

**生成结果**:
```html
<div class="box" />
<style>
.box {
    width: 300px;
}
.box:hover {
    width: 350px;
}
.box::before {
    content: ">";
}
</style>
```

**技术实现**:
1. 在 Parser 中识别 `&` 符号
2. 根据上下文推导类名/id（优先类名）
3. 支持伪类（:hover, :active, :focus 等）
4. 支持伪元素（::before, ::after 等）
5. 替换 `&` 为实际选择器

**新增功能**:
- `ContextResolver`: 上下文解析器
- `PseudoClassHandler`: 伪类/伪元素处理

**测试用例**: 8-10 个
**预计代码量**: ~250 行

---

#### Step 7.3: 全局样式块生成

**目标**: 生成独立的 `<style>` 标签，包含所有全局样式

**功能描述**:
```chtl
html {
    head {
        // 自动在这里插入全局样式块
    }
    body {
        div {
            style {
                .box { width: 100px; }
            }
        }
        div {
            style {
                .container { width: 200px; }
            }
        }
    }
}
```

**生成结果**:
```html
<html>
  <head>
    <style>
      .box { width: 100px; }
      .container { width: 200px; }
    </style>
  </head>
  <body>
    <div class="box" />
    <div class="container" />
  </body>
</html>
```

**技术实现**:
1. 在 Parser 阶段收集所有全局样式
2. 自动查找或创建 `<head>` 元素
3. 在 `<head>` 中插入 `<style>` 标签
4. 合并重复的选择器
5. 按字母顺序排序样式规则

**新增功能**:
- `StyleMerger`: 样式合并器
- `HeadInjector`: Head 注入器

**测试用例**: 6-8 个
**预计代码量**: ~200 行

---

### 🔥 第二阶段：高级表达式（v0.7.0）

**优先级**: ⭐⭐⭐⭐ 中高  
**预计工作量**: 3-4 周  
**目标**: 实现引用属性和条件表达式

#### Step 8.1: 引用属性（CHTL.md 203-236行）

**目标**: 引用其他元素的属性值

**功能描述**:
```chtl
div {
    id: box;
    style {
        width: 100px;
    }
}

div {
    style {
        width: box.width + 50px;  // 引用 box 的 width，结果为 150px
    }
}
```

**支持的选择器**:
- `box` - 自动推断（tag -> id -> class）
- `.box` - 类选择器
- `#box` - id选择器
- `button` - 标签选择器
- `.box button` - 后代选择器
- `button[0]` - 精确访问（数组索引）

**技术实现**:
1. 实现 CSS 选择器解析器
2. 构建元素查找系统
3. 实现属性引用解析
4. 支持运算和嵌套引用
5. 循环依赖检测

**新增组件**:
- `SelectorEngine`: 选择器引擎
- `AttributeResolver`: 属性解析器
- `DependencyGraph`: 依赖图（防循环依赖）

**测试用例**: 10-12 个
**预计代码量**: ~500 行
**难度**: ⭐⭐⭐⭐ 高

---

#### Step 8.2: 条件表达式（CHTL.md 238-334行）

**目标**: 支持三元运算符和条件判断

**功能描述**:
```chtl
div {
    style {
        width: true ? 100px : 200px;              // 三元运算符
        height: (50px > 30px) ? 100px : 50px;     // 比较运算
        display: isVisible ? "block" : "none";     // 变量条件
    }
}
```

**支持的运算符**:
- 比较: `>`, `<`, `>=`, `<=`, `==`, `!=`
- 逻辑: `&&`, `||`, `!`
- 三元: `? :`

**技术实现**:
1. 扩展表达式解析器（已有基础）
2. 添加比较运算符支持
3. 添加逻辑运算符支持
4. 实现三元运算符
5. 类型检查和转换

**新增功能**:
- `ConditionalParser`: 条件解析器
- `ComparisonEvaluator`: 比较求值器
- `LogicalEvaluator`: 逻辑求值器

**测试用例**: 10-12 个
**预计代码量**: ~400 行
**难度**: ⭐⭐⭐⭐ 高

---

### 🎨 第三阶段：模板系统（v0.8.0）

**优先级**: ⭐⭐⭐ 中  
**预计工作量**: 2-3 周  
**目标**: 实现模板定义和复用

#### Step 9.1: 模板定义（[Template]）

**功能描述**:
```chtl
[Template: Button]
{
    button {
        class: btn;
        style {
            padding: 10px 20px;
            background-color: $bgColor;    // 模板参数
            color: $textColor;
        }
        text: $label;
    }
}
```

**技术实现**:
1. 在 Lexer 中识别 `[Template: name]`
2. 解析模板参数（`$param`）
3. 存储模板定义
4. 参数替换机制

**新增组件**:
- `TemplateNode`: 模板节点
- `TemplateRegistry`: 模板注册表
- `ParameterSubstitutor`: 参数替换器

**测试用例**: 8-10 个
**预计代码量**: ~350 行

---

#### Step 9.2: 模板使用

**功能描述**:
```chtl
div {
    Button {
        $bgColor: #007bff;
        $textColor: white;
        $label: "Click Me";
    }
}
```

**技术实现**:
1. 识别模板调用
2. 参数传递
3. 模板实例化
4. 嵌套模板支持

**测试用例**: 6-8 个
**预计代码量**: ~250 行

---

### 📦 第四阶段：模块化（v0.9.0）

**优先级**: ⭐⭐⭐ 中  
**预计工作量**: 2 周  
**目标**: 实现导入系统和命名空间

#### Step 10.1: 导入系统（[Import]）

**功能描述**:
```chtl
[Import: "./components/button.chtl"]
[Import: "./styles/theme.chtl" as Theme]
```

**技术实现**:
1. 文件路径解析
2. 递归编译
3. 导入缓存
4. 循环导入检测

**新增组件**:
- `ImportResolver`: 导入解析器
- `FileCache`: 文件缓存
- `CompilationContext`: 编译上下文

**测试用例**: 8-10 个
**预计代码量**: ~300 行

---

#### Step 10.2: 命名空间

**功能描述**:
```chtl
[Namespace: Components]
{
    [Template: Button] { ... }
    [Template: Input] { ... }
}

// 使用
Components.Button { ... }
```

**技术实现**:
1. 命名空间解析
2. 作用域管理
3. 名称查找

**测试用例**: 6-8 个
**预计代码量**: ~200 行

---

### 🎯 第五阶段：优化和完善（v1.0.0）

**优先级**: ⭐⭐⭐⭐ 高  
**预计工作量**: 2-3 周  
**目标**: 达到生产环境最高标准

#### Step 11.1: 性能优化

**目标**:
- 编译速度提升 30%
- 内存使用减少 20%
- 支持增量编译

**实现**:
1. AST 缓存
2. 并行解析
3. 内存池优化
4. 懒加载

**预计代码量**: ~400 行

---

#### Step 11.2: 错误处理增强

**目标**:
- 更友好的错误信息
- 错误恢复机制增强
- IDE 集成支持

**实现**:
1. 彩色错误输出
2. 代码片段展示
3. 修复建议
4. Language Server Protocol (LSP)

**预计代码量**: ~300 行

---

#### Step 11.3: 工具链完善

**目标**:
- 格式化工具（chtl-fmt）
- 代码检查工具（chtl-lint）
- 包管理器（chtl-pkg）
- 在线 playground

**预计代码量**: ~1000 行

---

## 📈 里程碑时间表

```
v0.5.0 (当前)     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2025-10-15
                  │
                  ▼
v0.6.0 (样式增强)  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2025-11-05
  ├─ Step 7.1: 自动化类名/id (1 周)
  ├─ Step 7.2: 上下文推导& (1 周)
  └─ Step 7.3: 全局样式块 (1 周)
                  │
                  ▼
v0.7.0 (高级表达式) ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2025-12-03
  ├─ Step 8.1: 引用属性 (2 周)
  └─ Step 8.2: 条件表达式 (2 周)
                  │
                  ▼
v0.8.0 (模板系统)  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2025-12-24
  ├─ Step 9.1: 模板定义 (1.5 周)
  └─ Step 9.2: 模板使用 (1.5 周)
                  │
                  ▼
v0.9.0 (模块化)    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2026-01-14
  ├─ Step 10.1: 导入系统 (1 周)
  └─ Step 10.2: 命名空间 (1 周)
                  │
                  ▼
v1.0.0 (正式版)    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2026-02-04
  ├─ Step 11.1: 性能优化 (1 周)
  ├─ Step 11.2: 错误处理 (1 周)
  └─ Step 11.3: 工具链 (1 周)
```

---

## 📊 功能优先级矩阵

| 功能 | 优先级 | 复杂度 | 用户价值 | 规范要求 | 推荐顺序 |
|------|--------|--------|----------|----------|----------|
| 自动化类名/id | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 必需 | 1 |
| 上下文推导& | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 必需 | 2 |
| 全局样式块 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | 必需 | 3 |
| 引用属性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 可选 | 4 |
| 条件表达式 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 可选 | 5 |
| 模板定义 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | 推荐 | 6 |
| 模板使用 | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | 推荐 | 7 |
| 导入系统 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 推荐 | 8 |
| 命名空间 | ⭐⭐ | ⭐⭐ | ⭐⭐ | 可选 | 9 |

---

## 🎯 立即行动计划（本次实施）

### 阶段 1: 准备工作（30分钟）
- [x] 分析项目现状
- [x] 制定开发路线图
- [ ] 创建 Step 7 计划文档
- [ ] 更新项目版本号

### 阶段 2: Step 7.1 实现（3-4小时）
- [ ] 设计 GlobalStyleCollector 类
- [ ] 实现选择器解析
- [ ] 自动添加 class/id 属性
- [ ] 提取样式规则
- [ ] 编写测试用例
- [ ] 验证功能

### 阶段 3: Step 7.2 实现（3-4小时）
- [ ] 实现 & 符号识别
- [ ] 上下文推导逻辑
- [ ] 伪类/伪元素支持
- [ ] 编写测试用例
- [ ] 验证功能

### 阶段 4: Step 7.3 实现（2-3小时）
- [ ] 实现 <style> 标签生成
- [ ] Head 自动注入
- [ ] 样式合并和排序
- [ ] 编写测试用例
- [ ] 验证功能

### 阶段 5: 集成测试和文档（1-2小时）
- [ ] 运行完整测试套件
- [ ] 创建示例文件
- [ ] 更新 README.md
- [ ] 更新 CHANGELOG.md
- [ ] 创建 v0.6.0 发布说明

---

## 📝 技术债务和改进

### 已知问题
1. ✅ 颜色代码拆分问题（v0.5.0 已修复）
2. ✅ CSS 空格处理（v0.5.0 已修复）
3. ⚠️ JavaScript 字符串引号丢失（script 块）
4. ⚠️ 错误信息可以更友好

### 代码改进
1. 性能: 考虑使用 string_view 减少字符串拷贝
2. 内存: 实现对象池复用节点
3. 可维护性: 增加更多代码注释
4. 测试: 增加边界情况测试

---

## 🎓 技术选型和设计模式

### 当前使用的设计模式
- ✅ 访问者模式（AST 遍历）
- ✅ 递归下降（Parser）
- ✅ 智能指针（内存管理）
- ✅ RAII（资源管理）

### 计划使用的设计模式
- [ ] 策略模式（选择器匹配）
- [ ] 工厂模式（节点创建）
- [ ] 单例模式（全局样式收集器）
- [ ] 观察者模式（依赖追踪）
- [ ] 模板方法（表达式求值）

---

## 📚 文档计划

### 需要创建的文档
1. **STYLE_SYSTEM.md** - 样式系统详解
2. **TEMPLATE_GUIDE.md** - 模板系统指南
3. **API_REFERENCE.md** - API 参考手册
4. **CONTRIBUTING.md** - 贡献指南
5. **ARCHITECTURE.md** - 架构设计文档

### 需要更新的文档
1. README.md - 添加新功能说明
2. CHTL.md - 确保与实现一致
3. TUTORIAL.md - 添加新功能教程
4. EXAMPLES.md - 添加新示例

---

## 🚀 交付标准

### 每个 Step 的完成标准
- [ ] 功能完整实现
- [ ] 所有测试通过（100%）
- [ ] 零编译警告
- [ ] 代码覆盖率 > 90%
- [ ] 文档完整
- [ ] 示例可运行
- [ ] 性能符合预期
- [ ] 安全性检查通过

### v1.0.0 发布标准
- [ ] 规范符合度 > 95%
- [ ] 测试用例 > 150 个
- [ ] 文档完整（10+ 文档）
- [ ] 示例丰富（20+ 示例）
- [ ] 工具链完善
- [ ] 社区就绪（GitHub, 文档站点）

---

## 📞 总结

这是一个雄心勃勃但可实现的路线图。通过分阶段、有重点的开发，我们可以：

1. **v0.6.0**: 完善样式系统，达到实用级别（~3周）
2. **v0.7.0**: 实现高级表达式，提升表达能力（~4周）
3. **v0.8.0**: 模板系统，提高代码复用（~3周）
4. **v0.9.0**: 模块化，支持大型项目（~2周）
5. **v1.0.0**: 优化和完善，达到生产级别（~3周）

**总预计时间**: 约 15 周（~4 个月）

**当前进度**: 60% → 目标: 100%

让我们开始实施第一阶段：样式系统增强！

---

**制定人**: CHTL 开发团队  
**最后更新**: 2025-10-15  
**状态**: ✅ 已批准，准备实施
