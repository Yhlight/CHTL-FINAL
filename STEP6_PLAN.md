# Step 6 开发计划 - 优化与扩展

**日期**: 2025-10-14  
**当前版本**: v0.4.0-expression-support  
**目标版本**: v0.5.0

---

## 📋 开发策略

基于当前项目状态和 CHTL.md 规范，我们采用**渐进式优化**策略：

1. ✅ **优先修复已知问题** - 提升用户体验
2. ✅ **实现简单实用功能** - 快速增加价值
3. ⏸️ **暂缓复杂功能** - 控制风险

---

## 🎯 Step 6.1: 优化现有功能

### 问题清单

#### 问题 1: 颜色代码拆分

**当前行为**:
```chtl
style {
    background-color: #f0f0f0;
}
```

**错误输出**:
```html
style="background-color: # f0f0f0"
```

**原因**: Lexer 将 `#` 识别为注释开始

**解决方案**:
- 在 `style {}` 块中，`#` 后跟字母数字时识别为颜色
- 修改 Lexer 的上下文感知

---

#### 问题 2: 空格处理

**当前行为**:
```chtl
style {
    margin: 0 auto;
}
```

**可能输出**:
```html
style="margin: 0auto"
```

**原因**: Parser 的空格拼接逻辑不完善

**解决方案**:
- 改进 `parseStyleBlock()` 的值拼接逻辑
- 识别多个独立值的情况

---

### 优先级

- 🔴 **高优先级**: 问题 1（颜色代码）
- 🟡 **中优先级**: 问题 2（空格）

---

## 🎯 Step 6.2: 脚本块处理

### 规范依据

**CHTL.md** - script 块应该类似 style 块处理

### 功能描述

```chtl
button {
    id: "myButton";
    
    script {
        console.log("Hello!");
        this.addEventListener("click", function() {
            alert("Clicked!");
        });
    }
}
```

**预期输出**:
```html
<button id="myButton">
  <script>
    console.log("Hello!");
    this.addEventListener("click", function() {
        alert("Clicked!");
    });
  </script>
</button>
```

### 实现步骤

1. **创建 `ScriptNode` 类**
   - 类似 `StyleNode`
   - 存储 JavaScript 代码

2. **修改 Parser**
   - `parseScriptBlock()` 实现
   - 返回 `ScriptNode`

3. **修改 Generator**
   - `visit(ScriptNode&)` 实现
   - 生成 `<script>` 标签

4. **添加测试**
   - 基础脚本块
   - 内联脚本
   - 与其他元素结合

### 估计时间

- **实现**: 1-2 小时
- **测试**: 30 分钟
- **总计**: 1.5-2.5 小时

---

## 🎯 Step 6.3: 命名样式系统

### 规范依据

**CHTL.md 第336-348行** - 样式组模板

```chtl
[Template] @Style DefaultText {
    color: "black";
    line-height: 1.6;
}

div {
    style: DefaultText;  // 使用模板
}
```

### 功能描述

1. **定义样式模板**
   - `@Style` 块
   - 可复用的样式集合

2. **应用样式模板**
   - `style: TemplateName;`
   - 自动展开为内联样式

3. **生成全局样式**
   - 可选：生成 `<style>` 标签
   - CSS 类名

### 实现复杂度

- **中高**: 需要模板系统
- **时间**: 2-3 小时

---

## 📊 开发路线图

```
Step 6.1: 优化现有功能 ✅ (当前)
  ├─ 修复颜色代码拆分
  ├─ 优化空格处理
  └─ 改进错误提示

Step 6.2: 脚本块处理 ⏳
  ├─ ScriptNode 实现
  ├─ Parser 支持
  ├─ Generator 输出
  └─ 测试用例

Step 6.3: 命名样式 ⏳
  ├─ @Style 语法解析
  ├─ 模板存储
  ├─ 模板应用
  └─ 测试用例
```

---

## 🚀 实现顺序

### 第一阶段: 优化（30-60分钟）

1. ✅ 修复颜色代码问题
2. ✅ 优化空格处理
3. ✅ 测试验证

### 第二阶段: 脚本块（1.5-2.5小时）

1. ⏳ 实现 `ScriptNode`
2. ⏳ 修改 Parser 和 Generator
3. ⏳ 添加测试
4. ⏳ 更新文档

### 第三阶段: 命名样式（可选）

1. ⏸️ 研究模板系统
2. ⏸️ 实现基础版本
3. ⏸️ 测试和文档

---

## 📝 暂不实现的功能

### 引用属性 (CHTL.md 203-236行)

**原因**:
- 复杂度太高（需要两遍解析）
- 需要循环依赖检测
- 实现时间长（3-5天）

**状态**: ⏸️ 暂时跳过

---

### 条件表达式 (CHTL.md 238-334行)

**原因**:
- 需要实现逻辑运算符
- 需要比较运算符
- 三元运算符支持
- 复杂度较高

**状态**: ⏸️ 考虑简化版本

---

## 🎯 版本目标

### v0.5.0 目标

- ✅ 修复已知问题
- ✅ 实现脚本块
- ✅ 代码质量提升
- ✅ 文档更新

**交付标准**:
- 零警告编译
- 100% 测试通过
- 完整文档

---

## 💡 开发原则

1. **质量优先** - 不降低代码质量
2. **测试驱动** - TDD 方法
3. **小步迭代** - 每个功能独立
4. **用户价值** - 优先实用功能

---

**开始时间**: 2025-10-14  
**预计完成**: v0.5.0 - 2-4 小时
